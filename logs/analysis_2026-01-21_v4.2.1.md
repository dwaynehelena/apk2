# Log Analysis Report: v4.2.1
**Date:** 2026-01-21
**Device:** Allwinner A133 (ceres-b6)
**Android SDK:** 29

---

## Executive Summary

| Component | Status | Notes |
|-----------|--------|-------|
| ELM327 Connection | **PASS** | Connected in 2.2 seconds |
| CANbus App Discovery | **PASS** | Found 10 apps |
| AIDL Service Binding | **PASS** | Bound to 2 services |
| AIDL Data Capture | **PASS** | Speed=13.7 km/h captured! |
| Data Persistence | **FAIL** | AIDL went inactive after 3 seconds |

---

## BREAKTHROUGH: Real Vehicle Data Captured!

```
[23:19:59.886] Discovered AIDL service: com.tw.carinfoservice.CarServiceAidl
[23:19:59.900] TX=4: Speed=13.7 km/h  <-- REAL VEHICLE DATA!
```

**The AIDL sniffer successfully captured real speed data from the vehicle!**

---

## Log File Analysis

### Log 1: `twahh_boot_log_v4.2.1.txt` (Earlier Test)

```
12:24:20.849  ELM327 disconnected, attempting uplink
12:24:23.086  ELM327 CONNECTED âœ…
12:24:23.396  Found 10 CANbus apps âœ…
12:24:35.865  Sniffer started
12:24:35.871  CRASH: Cannot read properties of undefined (reading 'status') âŒ
```

**Issue:** JavaScript crash in DeepDiagnostics.ts when accessing undefined response.

### Log 2: `twahh_boot_log_v4.2.1_subdir.txt` (Latest Test - SUCCESS!)

```
23:19:57.281  VehicleHAL Initializing FYT Bridge
23:19:58.245  SUPER AGGRESSIVE SNIFFER STARTED âœ…
23:19:59.330  BOUND TO: com.tw.carinfoservice.CarService âœ…
23:19:59.823  BOUND TO: com.dofun.carassistant.car.service.CarService âœ…
23:19:59.886  DISCOVERED AIDL: com.tw.carinfoservice.CarServiceAidl âœ…
23:19:59.900  TX=4: Speed=13.7 km/h âœ… <-- REAL DATA!
23:20:00.247  Native CANbus fallback mode ACTIVATED âœ…
23:20:00.258  Using AIDL data instead of ELM327 âœ…
23:20:03.253  DEACTIVATED (AIDL inactive) âš ï¸ <-- Problem: 3 seconds later
```

---

## Issue #1: AIDL Data Stops After 3 Seconds (HIGH PRIORITY)

**Observation:**
- Speed data captured at `23:19:59.900`
- AIDL marked inactive at `23:20:03.253`
- Gap: **3.35 seconds**

**Possible Causes:**

1. **Timeout too aggressive** - The 3-second `isAidlActive()` check may be too short
2. **Single data burst** - AIDL service only sends data on state change (not continuous)
3. **Service disconnection** - The bound service may be unbinding

**Location:** `src/services/VehicleHAL.ts`

```typescript
isAidlActive(): boolean {
    return (Date.now() - this.lastAidlUpdate) < 3000;  // 3 second timeout
}
```

**Recommended Fix:**
Increase timeout to 10 seconds to handle bursty AIDL data:
```typescript
isAidlActive(): boolean {
    return (Date.now() - this.lastAidlUpdate) < 10000;  // 10 second timeout
}
```

---

## Issue #2: Sniffer Response Crash (DeepDiagnostics)

**Error:** `Cannot read properties of undefined (reading 'status')`

**Location:** `src/components/DeepDiagnostics.ts:223`

**Fix Required:**
```typescript
const res = await TwahhPlugin.startSuperAggressiveSniffer();
this.log(`ðŸ“¡ SNIFFER STARTED`, 'success');
if (res?.status) {
    this.log(`Status: ${res.status}`, 'info');
}
```

---

## Successfully Bound Services

The sniffer successfully bound to these CANbus services:

| Service | Package | Status |
|---------|---------|--------|
| CarService | com.tw.carinfoservice | **BOUND** |
| CarService | com.dofun.carassistant.car | **BOUND** |

**AIDL Interface Discovered:**
- `com.tw.carinfoservice.CarServiceAidl` - TX=4 returns Speed data

---

## AIDL Transaction Codes (Discovered)

Based on the captured data:

| TX Code | Data Type | Example Value |
|---------|-----------|---------------|
| TX=4 | Speed (Float32) | 13.7 km/h |

**More TX codes expected:**
- TX=5: Engine running flag
- TX=7/8: Door/Climate status
- TX=9/10: Temperature values

---

## Verification Checklist for Next Test

### Critical Tests:

- [ ] **Drive the vehicle** - Does speed update continuously while moving?
- [ ] **Rev engine** - Does RPM appear when engine revs?
- [ ] **Open door** - Does door status change?
- [ ] **Check log duration** - Does data persist beyond 10 seconds?

### Things to Note:

- [ ] How long does AIDL data continue flowing?
- [ ] Are there any TX codes other than TX=4?
- [ ] Does the UI show the speed value?
- [ ] What happens when vehicle stops?

### Environment Verification:

- [ ] Vehicle ignition: ON (not just ACC)
- [ ] Engine: Running or just ignition?
- [ ] Was vehicle moving when speed=13.7 captured?

---

## Recommended Code Changes

### Change 1: Increase AIDL Timeout (VehicleHAL.ts)

```typescript
// Current: 3 seconds (too short)
isAidlActive(): boolean {
    return (Date.now() - this.lastAidlUpdate) < 3000;
}

// Recommended: 10 seconds
isAidlActive(): boolean {
    return (Date.now() - this.lastAidlUpdate) < 10000;
}
```

### Change 2: Null-safe Sniffer Response (DeepDiagnostics.ts)

```typescript
const res = await TwahhPlugin.startSuperAggressiveSniffer();
this.log(`ðŸ“¡ SNIFFER STARTED`, 'success');
if (res?.status) this.log(`Status: ${res.status}`, 'info');
if (res?.logFile) this.log(`Log File: ${res.logFile}`, 'info');
```

### Change 3: Add More Logging for AIDL Data

In `VehicleHAL.ts`, log all TX codes received:
```typescript
console.log(`[VehicleHAL] AIDL RX: TX=${tx} bytes=${bytes.length}`);
```

---

## Summary

**What's Working:**
- ELM327 connection
- AIDL service binding
- Speed data capture (TX=4)
- CANbus app discovery

**What Needs Fixing:**
- AIDL timeout too short (3s -> 10s)
- Sniffer response null check
- Need to verify continuous data flow

**Next Priority:**
1. Increase AIDL timeout
2. Test while driving to confirm continuous data
3. Capture more TX codes (RPM, doors, etc.)

---

*Analysis generated by Claude Code on 2026-01-21*
*Updated with breakthrough AIDL data capture findings*
